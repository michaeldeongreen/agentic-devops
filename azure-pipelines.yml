# Development pipeline for Terraform-based infrastructure.
# Uses VARIABLE-GROUP-DEV for environment values.

trigger:
  branches:
    include:
      - main

variables:
  - group: VARIABLE-GROUP-DEV
  # Set these in the variable group or override at queue time.
  - name: AZURE_SERVICE_CONNECTION
    value: 'sc-terraform-azure-agentic-dev'
  - name: TF_STATE_RESOURCE_GROUP
    value: '$(RESOURCE_GROUP)'
  # App-specific values (set these in the variable group for dev).
  - name: APP_SERVICE_NAME
    value: 'agentic-devops-webapi-dev'
  - name: APP_SERVICE_NAME_UI
    value: 'agentic-devops-ui-dev'
  - name: APP_SERVICE_PLAN_NAME
    value: 'asp-agentic-devops-dev'
  - name: APP_INSIGHTS_NAME
    value: 'appi-agentic-devops-dev'

stages:
  - stage: Deploy_Dev
    displayName: 'Deploy DEV Infrastructure'
    jobs:
      - deployment: DeployInfraDev
        displayName: 'Terraform Apply (DEV)'
        environment: DEVELOPMENT
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self
                - template: pipelines/templates/terraform-steps.yml
                  parameters:
                    environmentName: 'dev'
                    azureServiceConnection: '$(AZURE_SERVICE_CONNECTION)'
                    workingDirectory: '$(Build.SourcesDirectory)/infra/terraform/envs/dev'
                    tfStateResourceGroup: '$(TF_STATE_RESOURCE_GROUP)'
                    tfStateStorageAccount: '$(STORAGE_ACCOUNT_NAME)'
                    tfStateContainer: '$(STORAGE_ACCOUNT_CONTAINER_NAME)'
                    tfStateKey: '$(TF_STATE_KEY)'
                    resourceGroupName: '$(RESOURCE_GROUP)'
                    appServiceName: '$(APP_SERVICE_NAME)'
                    appServiceNameUi: '$(APP_SERVICE_NAME_UI)'
                    appServicePlanName: '$(APP_SERVICE_PLAN_NAME)'
                    appServicePlanSkuName: 'B1'
                    appInsightsName: '$(APP_INSIGHTS_NAME)'
                    linuxFxVersion: 'DOTNETCORE|9.0'
